<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promptium｜輕鬆分享提示詞模板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&family=Noto+Sans+TC:wght@100..900&family=Racing+Sans+One&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="./static/favicon.ico">
    <style>
        * {
            font-family: "Noto Sans Mono", "Noto Sans TC", sans-serif;
            scrollbar-color: #ececec transparent;
            box-sizing: border-box;
        }

        body {
            height: 105vh;
            position: relative;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            width: 100%;
            font-size: 1rem;
        }

        .ask-sec,
        .reply-sec {
            height: 176px;
            overflow-y: auto;
            width: calc(100% - 30px);
        }

        .accordion-button:focus {
            z-index: 3;
            border-color: rgba(0, 0, 0, .125);
            outline: 0;
            box-shadow: 0 0 0 .25rem rgba(0, 0, 0, .125);
        }

        .accordion-button:not(.collapsed) {
            color: #ffffff;
            background-color: rgba(0, 0, 0, .8);
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
        }

        .accordion-button:not(.collapsed)::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23212529'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }

        #lodgSec h1 {
            font-family: "Racing Sans One", sans-serif;
            font-weight: 400;
            font-style: normal;
            font-size: 64px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }



        a:hover h1,
        .list-group {
            cursor: pointer;
        }

        a.text-decoration-none h1 {
            color: inherit;
            /* 繼承父元素的文字顏色 */
        }

        #shareCopyAlert {
            bottom: 10px;
            right: 20px;
            z-index: 999;
            width: 200px;
            position: fixed;
        }

        #modalContent h1 {
            font-size: 2rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        #modalContent h2 {
            font-size: 1.75rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        #modalContent h3 {
            font-size: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        #modalContent h4 {
            font-size: 1.25rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        #modalContent h5 {
            font-size: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        #modalContent h6 {
            font-size: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        #modalContent p {
            font-size: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div class="alert alert-success mt-3" id="shareCopyAlert" style="display:none;">已成功複製連結！</div>
    <div class="container px-5 pt-5" style="max-width: 56rem; min-height: 130vh;">
        <div class="row mb-4">
            <div class="row mb-4" id="lodgSec">
                <a href="/" class="text-decoration-none link-dark">
                    <h1 class="text-center no-select">Promptium</h1>
                </a>
            </div>
        </div>
        <div class="row mb-4">
            <h2 class="fs-6 mb-3 fw-bold">如何使用</h2>
            <p>
                使用 Promptium 可以輕鬆的分享提示詞模板，只要輸入提示詞的名稱、說明和模板，並點擊產生分享連結，即可完成分享。更棒的是，啟用 Promptium
                的進階功能後，還能將使用案例一併分享出去。
            </p>
            <p class="m-0">
                <a class="btn btn-dark btn-sm" href="./index.html" role="button">
                    返回首頁
                </a>
                <a class="btn btn-dark btn-sm" role="button"
                    href="./flow.html#data/eyJkZXNjcmlwdGlvbiI6IumAmeaYr+S4gOWAi+eUqOS+huWwh+aWsOiBnuaUueWvq+aIkOiyvOaWh+eahOaPkOekuuipnua1geeoi++8jOacg+WFiOiriyBBSSDmjIflh7rnpL7nvqTosrzmlofnmoTmp4vmiJDopoHntKDvvIzmjqXokZfkvp3nhafopoHntKDlkozkvb/nlKjogIXmj5DkvpvnmoTlj4PogIPos4fmlpnmkrDlr6vnpL7nvqTosrzmlofvvIznhLblvozoh6rmiJHmqqLoqI7vvIzmnIDntYLnlKLlh7rkv67mlLnlvoznmoTosrzmlofjgIIiLCJuYW1lIjoi5bCH5paw6IGe5pS55a+r5oiQ6LK85paH55qE5o+Q56S66Kme5rWB56iLIiwidGVtcGVyYXR1cmUiOiIwLjMiLCJleGVjdXRlIjoiMSIsInByb21wdHMiOlsi6KuL5ZWP56S+576k6LK85paH55qE5qeL5oiQ6KaB57Sg5pyJ5ZOq5Lqb77yfIiwi6KuL5L6d54Wn6KaB57Sg77yM5bCH5Lul5LiL5Y+D6ICD6LOH5paZ5pKw5a+r54K656S+576k6LK85paH44CCXG5cbi0tLVxuXG4jIOOAiOWPsOiCoemWi+ebpOOAieWFg+aciOihjOaDheWHuuW4q+S4jeWIqe+8nzIwMjXlubTplovntIXnm6Tot4znmb7pu57nl5vlpLEy6JCsM+WPiuWto+e3mlxuXG7piYXkuqjntrLoqJjogIXlvLXmrL3nmbwg5Y+w5YyXwqDCoDIwMjUtMDEtMDIgMDk6MzdcblxuIVtjb3ZlciBpbWFnZSBvZiBuZXdzIGFydGljbGVdKGh0dHBzOi8vbmV3cy5jbnllcy5jb20vX25leHQvaW1hZ2U/dXJsPWh0dHBzJTNBJTJGJTJGY2ltZy5jbnllcy5jb29sJTJGcHJvZCUyRm5ld3MlMkY1ODIzNzk4JTJGbCUyRjVjM2QyZDk1YTE1NDg4NTQ2YmQ1YTc0ZmRiNjNmOWQwLmpwZyZ3PTM4NDAmcT03NSlcblxu44CI5Y+w6IKh6ZaL55uk44CJ5YWD5pyI6KGM5oOF5Ye65bir5LiN5Yip77yfMjAyNeW5tOmWi+e0heebpOi3jOeZvum7nueXm+WksTLokKwz5Y+K5a2j57ea44CCKOmJheS6qOe2suiomOiAheW8teasveeZvOaUnSlcblxu5Y+w5YyX6IKh5biCICgyKSDml6Xplovlh7ogMjAyNSDlubTpppbml6Xplovnm6TvvIzlnKjpgKPml6XluILloLTph4/og73okI7nuK7kuYvkuIvvvIzluILloLTkurrmsKPmnKropovmnInmlYjlm57nsaDvvIzlj7DogqHpm4bkuK3luILloLTliqDmrIrogqHlg7nmjIfmlbjku6UgMjI5NzUuNzEg6bue5bmz5L2O55uk6ZaL5Ye6IO+8jOacquimi+mgmOmgreaXj+e+pO+8jOWPsOepjembuyAoWzIzMzAtVFddKGh0dHBzOi8vd3d3LmNueWVzLmNvbS90d3N0b2NrLzIzMzApKSDku6UgMTA3MCDlhYPplovlh7rvvIzluILloLTlsIjlrrbmjIflh7rvvIzlj7DogqHlnKggNSDml6Xnt5rkuYvkuIvpnIfnm6rvvIzkvYbmioDooZPpq5jmqpTmjIfmqJnlsJrmnKropovovYnlvLHvvIzmipXos4fkurrku6XljYDplpPmk43kvZzniLLlrpzjgIJcblxu5Y+w5YyX6IKh5biCIDIg5pel6ZuG5Lit5biC5aC05Yqg5qyK6IKh5YO55oyH5pW45pep55uk5LulwqAgMjI5NzUuNzEg6bue6ZaL5Ye677yM5pep55uk5oyH5pW45pyA5L2OIDIyOTIyLjM2IOm7nu+8jOaRnOegtOWto+e3muS4pueXm+WksSAyIOiQrCAzIOmXnOWNoe+8jOacgOmrmOS+huWIsCAyMzAzNS41OCDpu57vvIzpoJDoqIjlhajloLTmiJDkuqTlgLwgMjYwOSDlhITlhYPjgILnm6TkuK3ph5Hono3ogqHot4wgMC4yJe+8jOiIqumBi+iCoeS4iua8siAwLjQ0Je+8jOingOWFiemkkOmjsumhnuiCoeS4iua8siAwLjE3Je+8jOmbu+WtkOiCoeS4i+i3jCAwLjI0JeOAglxuXG7os4fmt7HorYnliLjliIbmnpDluKvnsKHkvK/lhIDmjIflh7rvvIzlj7DogqHlkYjnj77ph4/nuK7pnIfnm6rmoLzlsYDvvIzlnKjlpKfnm6Tot4znoLQgNSDml6Xnt5rkuJTph4/og73okI7nuK7kuYvkuIvvvIzku6XljYDplpPmk43kvZzniLLlrpzjgIJcblxu6LOH5rex6K2J5Yi45YiG5p6Q5bir6buD5ryi5oiQ6Kqq77yM5Y+w6IKh6KaB55WZ5oSP5qmf5Zmo5Lq65Y+K57ay6YCa5qaC5b+16IKh55qE5YaN5bqm5Zm05Ye677yM5rOo5oSPIDEyIOaciOeHn+aUtueahOihqOePvuOAguWwpOWFtuWcqCAxMiDmnIjmnInmqJnmoYjlhaXluLPnmoTntrLpgJrogqHml4/nvqTkuIrjgIJcblxu5pep55uk5Y+w6IKh5qyK5YC86IKh5Y+w56mN6Zu75LiL6LeM44CB5buj6YGUIChbMjM4Mi1UV10oaHR0cHM6Ly93d3cuY255ZXMuY29tL3R3c3RvY2svMjM4MikpIOS4iua8suOAgem0u+a1tyAoWzIzMTctVFddKGh0dHBzOi8vd3d3LmNueWVzLmNvbS90d3N0b2NrLzIzMTcpKSDlj4roga/nmbznp5EgKFsyNDU0LVRXXShodHRwczovL3d3dy5jbnllcy5jb20vdHdzdG9jay8yNDU0KSkg5LuK5aSp5pep55uk6LWw5by377yM6JiL5p6c5qaC5b+16IKh55qE5aSn56uL5YWJIChbMzAwOC1UV10oaHR0cHM6Ly93d3cuY255ZXMuY29tL3R3c3RvY2svMzAwOCkpIOi1sOW5syDvvIznjonmmbblhYkgKFszNDA2LVRXXShodHRwczovL3d3dy5jbnllcy5jb20vdHdzdG9jay8zNDA2KSkg6IKh5YO55by35Yui5LiK5ryy44CCXG5cbklDIOi8ieadv+mhnuiCoei1sOWLouS6kueVsOS4iu+8jOaso+iIiCAoWzMwMzctVFddKGh0dHBzOi8vd3d3LmNueWVzLmNvbS90d3N0b2NrLzMwMzcpKSDkuIrmvLLjgIHmma/noqkgKFszMTg5LVRXXShodHRwczovL3d3dy5jbnllcy5jb20vdHdzdG9jay8zMTg5KSkg5Y+K5Y2X6Zu7IChbODA0Ni1UV10oaHR0cHM6Ly93d3cuY255ZXMuY29tL3R3c3RvY2svODA0NikpIOa8sui3jOS6kuimi+OAguiAjOiyqOarg+iIqumBi+mVt+amriAoWzI2MDMtVFddKGh0dHBzOi8vd3d3LmNueWVzLmNvbS90d3N0b2NrLzI2MDMpKeOAgeiQrOa1tyAoWzI2MTUtVFddKGh0dHBzOi8vd3d3LmNueWVzLmNvbS90d3N0b2NrLzI2MTUpKSDlj4rpmb3mmI4gKFsyNjA5LVRXXShodHRwczovL3d3dy5jbnllcy5jb20vdHdzdG9jay8yNjA5KSkg5pep55uk5YWo5pW45LiK5ryy77yM5Lim5Lul6JCs5rW355qE5ryy5Yui5pyA5by344CCXG5cbuWcqOaTjeS9nOW7uuitsOS4iu+8jOWci+elqOitieWIuOaMh+WHuu+8jOeVtuWJjeWFt+WfuuacrOmdouS9s+WAi+iCoe+8jOiCoeWDueiLpeaciemBqeW6puWbnuaqlO+8jOWunOWwi+imk+WIh+WFpeapn+acg+OAgui/keaXpeebpOmdouS4iu+8jOWFiemAmuOAgeapn+WZqOS6uuWSjCBCQlXvvIzovKrnlarngrros4fph5HogZrpm4bopoHlnLDvvIznlbbliY3nhrHluqbmnKrmtojvvIzku43lj6/lgY/lpJrlm6Dmh4njgILlj6bmnb/ljaHml4/nvqTmlrwgQ0VTIOWxleS4iuaOqOWHuuaWsOeahOmhr+WNoe+8jOacieacm+W8lei1t+aPm+apn+a9rua1ge+8jOebuOmXnOWkp+W7oOeHn+mBi+WPr+acn++8jOeVtuWJjeiCoeWDueW3sumBqeW6puS/ruato++8jOWPr+epjealteWBj+WkmuW4g+WxgOOAgiIsIuiri+WVj+mAmeWAi+iyvOaWh+acieWTquS6m+aUuemAsuS5i+iZle+8nyIsIuiri+mAsuihjOS/ruaUueOAgiJdfQ==">
                    使用範例
                </a>
            </p>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <h2 class="fs-6 mb-3 fw-bold">開始製作</h2>
            </div>
            <div class="col-12 mb-2">
                <input type="text" class="form-control" id="name-input" placeholder="請填寫流程名稱" value="">
            </div>
            <div class="col-12 mb-3">
                <textarea class="form-control" id="description-textarea" placeholder="請填寫流程說明" rows="5"></textarea>
            </div>
            <div class="col-12">
                <button id="add-btn" type="button" class="btn btn-dark btn-sm">增加流程</button>
                <button id="remove-btn" type="button" class="btn btn-dark btn-sm">減少流程</button>
            </div>
        </div>
        <div class="accordion mb-3" id="accordionContainer">
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading0">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse0" aria-expanded="false" aria-controls="collapse0">
                        使用前別忘記要設定 ChatGPT
                    </button>
                </h2>
                <div id="collapse0" class="accordion-collapse collapse" aria-labelledby="heading0">
                    <div class="accordion-body p-4">
                        <div class="mb-3">
                            <label for="openaiApikeyInput" class="form-label">OpenAI 的 API 金鑰</label>
                            <input class="form-control" id="openai-apikey-input" placeholder="">
                        </div>
                        <div class="mb-3">
                            <label for="anthropicApikeyInput" class="form-label">Anthropic 的 API 金鑰</label>
                            <input class="form-control" id="anthropic-apikey-input" placeholder="">
                        </div>
                        <div class="mb-3">
                            <label for="deepseekApikeyInput" class="form-label">DeepSeek 的 API 金鑰</label>
                            <input class="form-control" id="deepseek-apikey-input" placeholder="">
                        </div>
                        <div class="mb-3">
                            <label for="provideSelect" class="form-label">選擇服務</label>
                            <select class="form-select" id="provide-select"></select>
                        </div>
                        <div class="mb-3">
                            <label for="temperature-input" class="form-label">發散程度：</label>
                            <input type="range" class="form-range" min="0" max="2" step="0.1" value="0.3"
                                id="temperature-input">
                        </div>
                        <div>
                            <label for="execute-input" class="form-label">執行次數：</label>
                            <input type="range" class="form-range" min="1" max="20" step="1" value="1"
                                id="execute-input">
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading1">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                        提示詞流程 #1
                    </button>
                </h2>
                <div id="collapse1" class="accordion-collapse collapse" aria-labelledby="heading1">
                    <div class="accordion-body p-4">
                        <textarea class="form-control p-3" id="formControlTextarea1" placeholder="寫點提示詞吧！">hi</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <button type="button" class="btn btn-dark w-100" id="send-btn" disabled>送出</button>
        </div>
        <div class="mb-3">
            <div class="row">
                <div class="col-3">
                    <button id="save-btn" type="button" class="w-100 btn btn-dark">保存流程</button>
                </div>
                <div class="col-3">
                    <button id="clear-btn" type="button" class="w-100 btn btn-dark">清除流程</button>
                </div>
                <div class="col-3">
                    <button id="reset-btn" type="button" class="w-100 btn btn-dark">清除結果</button>
                </div>
                <div class="col-3">
                    <button id="close-btn" type="button" class="w-100 btn btn-dark">關閉結果</button>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div id="save-link-section"></div>
        </div>

        <div class="mb-5" id="result"></div>
    </div>
    <footer class="mt-auto text-white-50 bg-dark text-center d-flex justify-content-center align-items-center"
        style="height: 50px;">
        <a class="mx-2 link-light" target="_blank" href="https://x.com/lloyd3126">
            Made by Chen Chung Nien
        </a>
        <a class="mx-2 link-light" target="_blank" href="https://prompter.fofr.ai/">
            Inspired by @fofrAI
        </a>
        <a class="mx-2 link-light" target="_blank" href="https://buymeacoffee.com/niencc">
            Buy me a coffee
        </a>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script>
        const md = window.markdownit();
        let mdResult = "";
        let replyArr = []

        // 定義服務提供商選項
        const providerOptions = {
            openai: [
                { value: 'openai:gpt-4o', text: 'OpenAI: gpt-4o' },
                { value: 'openai:gpt-4o-mini', text: 'OpenAI: gpt-4o-mini' }
            ],
            anthropic: [
                { value: 'anthropic:claude-3-5-sonnet-latest', text: 'Anthropic: claude-3.5-sonnet-latest' },
                { value: 'anthropic:claude-3-5-haiku-latest', text: 'Anthropic: claude-3.5-haiku-latest' }
            ],
            deepseek: [
                { value: 'deepseek:deepseek-chat', text: 'DeepSeek: deepseek-chat' }
            ]
        };

        // 更新提供商選項的函數
        function updateProviderOptions() {
            const select = document.getElementById('provide-select');
            select.innerHTML = ''; // 清空現有選項

            const openaiKey = document.getElementById('openai-apikey-input').value.trim();
            const anthropicKey = document.getElementById('anthropic-apikey-input').value.trim();
            const deepseekKey = document.getElementById('deepseek-apikey-input').value.trim();

            // 根據 API key 添加對應選項
            if (openaiKey) {
                providerOptions.openai.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    select.appendChild(opt);
                });
            }

            if (anthropicKey) {
                providerOptions.anthropic.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    select.appendChild(opt);
                });
            }

            if (deepseekKey) {
                providerOptions.deepseek.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    select.appendChild(opt);
                });
            }

            // 如果沒有任何選項,添加一個提示選項
            if (select.options.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '請先填寫 API KEY';
                opt.disabled = true;
                select.appendChild(opt);
            }
        }

        // 修改後的 checkApiKey 函數
        function checkApiKey() {
            const sendBtn = document.getElementById("send-btn");
            const openaiKey = document.getElementById("openai-apikey-input").value.trim();
            const anthropicKey = document.getElementById("anthropic-apikey-input").value.trim();
            const deepseekKey = document.getElementById("deepseek-apikey-input").value.trim();

            // 只要有任一 API key 被填寫即可啟用發送按鈕
            const hasValidKey = openaiKey !== "" || anthropicKey !== "" || deepseekKey !== "";

            // 啟用或禁用發送按鈕
            sendBtn.disabled = !hasValidKey;
        }

        // 為所有 API key 輸入框添加事件監聽
        document.getElementById("openai-apikey-input").addEventListener('input', () => {
            updateProviderOptions();
            checkApiKey();
        });
        document.getElementById("anthropic-apikey-input").addEventListener('input', () => {
            updateProviderOptions();
            checkApiKey();
        });
        document.getElementById("deepseek-apikey-input").addEventListener('input', () => {
            updateProviderOptions();
            checkApiKey();
        });


        function decodeFromHash() {
            if (location.hash.startsWith('#data/')) {
                const base64 = location.hash.replace('#data/', '');
                try {
                    const decodedPrompt = fromBase64(base64);
                    const data = JSON.parse(decodedPrompt);
                    document.getElementById("description-textarea").value = data.description || "";
                    document.getElementById("name-input").value = data.name || "";
                    document.getElementById("temperature-input").value = data.temperature;
                    document.getElementById("execute-input").value = data.execute;
                    document.getElementById("temperature-input").previousElementSibling.textContent = `發散程度：${data.temperature}`
                    document.getElementById("execute-input").previousElementSibling.textContent = `執行次數：${data.execute}`
                    data.prompts.forEach(function (prompt, index) {
                        if (index === 0) {
                            // 為第一個提示詞更新現有的輸入欄位
                            const firstTextarea = document.getElementById("formControlTextarea1");
                            firstTextarea.value = prompt;
                            firstTextarea.style.height = "300px";
                        } else {
                            // 為其餘提示詞建立新的輸入欄位
                            const accordionContainer = document.getElementById("accordionContainer");
                            const accordionItem = document.createElement("div");
                            accordionItem.className = "accordion-item";

                            const accordionHeader = document.createElement("h2");
                            accordionHeader.className = "accordion-header";

                            const accordionButton = document.createElement("button");
                            accordionButton.className = "accordion-button collapsed";
                            accordionButton.type = "button";
                            accordionButton.setAttribute("data-bs-toggle", "collapse");
                            accordionButton.setAttribute("data-bs-target", `#collapse${index + 1}`);
                            accordionButton.setAttribute("aria-controls", `collapse${index + 1}`);
                            accordionButton.textContent = `提示詞流程 #${index + 1}`;

                            accordionHeader.appendChild(accordionButton);

                            const accordionCollapse = document.createElement("div");
                            accordionCollapse.id = `collapse${index + 1}`;
                            accordionCollapse.className = "accordion-collapse collapse";
                            accordionCollapse.setAttribute("aria-labelledby", `heading${index + 1}`);

                            const accordionBody = document.createElement("div");
                            accordionBody.className = "accordion-body p-4";

                            const textarea = document.createElement("textarea");
                            textarea.className = "form-control p-3";
                            textarea.id = `formControlTextarea${index + 1}`;
                            textarea.placeholder = "寫點提示詞吧！";
                            textarea.value = prompt;

                            accordionBody.appendChild(textarea);
                            accordionCollapse.appendChild(accordionBody);
                            accordionItem.appendChild(accordionHeader);
                            accordionItem.appendChild(accordionCollapse);
                            accordionContainer.appendChild(accordionItem);

                            textarea.style.height = "300px";
                            textarea.addEventListener("input", function (e) {
                                document.getElementById("save-link-section").innerHTML = "";
                                textarea.style.height = "300px";
                            });
                        }
                    });
                } catch (e) {
                    console.error("解碼時發生錯誤: ", e);
                }
            }
        }

        function handleHashChange() {
            decodeFromHash();
        }

        // 在頁面載入時初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 讀取儲存的 API keys
            const savedOpenAIApiKey = localStorage.getItem('openai_api_key');
            if (savedOpenAIApiKey) {
                document.getElementById("openai-apikey-input").value = savedOpenAIApiKey;
            }
            const savedAnthropicApiKey = localStorage.getItem('anthropic_api_key');
            if (savedAnthropicApiKey) {
                document.getElementById("anthropic-apikey-input").value = savedAnthropicApiKey;
            }
            const savedDeepSeekApiKey = localStorage.getItem('deepseek_api_key');
            if (savedDeepSeekApiKey) {
                document.getElementById("deepseek-apikey-input").value = savedDeepSeekApiKey;
            }

            // 初始化選項和檢查 API key
            updateProviderOptions();
            checkApiKey();
            handleHashChange();
            window.addEventListener('hashchange', handleHashChange);
        });

        /**
             * Base64 編碼：支持中文
             */
        function toBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        /**
         * Base64 解碼：與上面配套
         */
        function fromBase64(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        document.getElementById("save-btn").addEventListener("click", function () {
            const data = {
                description: document.getElementById("description-textarea").value || "",
                name: document.getElementById("name-input").value || "",
                temperature: document.getElementById("temperature-input").value,
                execute: document.getElementById("execute-input").value,
                prompts: []
            };
            document.querySelectorAll("#accordionContainer textarea").forEach(function (textarea) {
                data.prompts.push(textarea.value);
            });
            const jsonStr = JSON.stringify(data);
            const base64 = toBase64(jsonStr);
            const shareURL = `${window.location.origin}${window.location.pathname}#data/${base64}`;
            window.history.replaceState(null, '', shareURL);
            document.getElementById("save-link-section").innerHTML = `
                <div class="row mt-3">
                    <div class="col-9 col-md-10">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1">編輯連結</span>
                            <input type="text" class="form-control bg-white" id="shareLinkTextarea1" readonly value="${shareURL}">
                        </div>
                    </div>
                    <div class="col-3 col-md-2">
                        <button id="copy-btn1" type="button" class="w-100 btn btn-dark">複製</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-9 col-md-10">
                        <div class="input-group">
                            <span class="input-group-text" id="basic-addon1">分享連結</span>
                            <input type="text" class="form-control bg-white" id="shareLinkTextarea2" readonly>
                        </div>
                    </div>
                    <div class="col-3 col-md-2">
                        <button id="copy-btn2" type="button" class="w-100 btn btn-dark">複製</button>
                    </div>
                </div>
                
            `;

            document.getElementById("copy-btn1").addEventListener('click', () => {
                document.getElementById("shareLinkTextarea1").select();
                document.getElementById("shareLinkTextarea1").setSelectionRange(0, 99999);
                document.execCommand('copy');
                shareCopyAlert.style.display = 'block';
                setTimeout(() => {
                    shareCopyAlert.style.display = 'none';
                }, 2000);
            });

            document.getElementById("copy-btn2").addEventListener('click', () => {
                document.getElementById("shareLinkTextarea2").select();
                document.getElementById("shareLinkTextarea2").setSelectionRange(0, 99999);
                document.execCommand('copy');
                shareCopyAlert.style.display = 'block';
                setTimeout(() => {
                    shareCopyAlert.style.display = 'none';
                }, 2000);
            });



            const apiKeys = [
                '4070ff49d794e73714543b663c974755ecd6b036909a04df8a38b58d65165567c4f5d6',
                '4070ff49d794e73714533b663c974755ecd6b036909904df8a38b58d65165567c4f5d6',
                '4070ff49d794e73714523b663c974755ecd6b036909804df8a38b58d65165567c4f5d6'
            ];

            const selectedApiKey = apiKeys[Math.floor(Math.random() * apiKeys.length)];

            fetch('https://api.reurl.cc/shorten', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'reurl-api-key': selectedApiKey
                },
                body: JSON.stringify({
                    "url": shareLinkTextarea1.value,
                    "utm_source": ""
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.res === 'success') {
                        shareLinkTextarea2.value = data.short_url;
                    } else {
                        shareLinkTextarea2.value = '無法產生短網址';
                    }
                });
        });

        // 當 API key 輸入框值改變時，保存到 localStorage
        document.getElementById("openai-apikey-input").addEventListener('change', function () {
            localStorage.setItem('openai_api_key', this.value);
            checkApiKey();
        });
        document.getElementById("anthropic-apikey-input").addEventListener('change', function () {
            localStorage.setItem('anthropic_api_key', this.value);
            checkApiKey();
        });
        document.getElementById("deepseek-apikey-input").addEventListener('change', function () {
            localStorage.setItem('deepseek_api_key', this.value);
            checkApiKey();
        });

        document.querySelectorAll("#accordionContainer textarea").forEach(function (textarea) {
            textarea.style.height = "300px";
            textarea.addEventListener("input", function (e) {
                document.getElementById("save-link-section").innerHTML = "";
                this.style.height = "300px";
            });
        });
        document.getElementById("add-btn").addEventListener("click", function () {
            document.getElementById("save-link-section").innerHTML = "";
            const accordionContainer = document.getElementById("accordionContainer");
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item";
            const accordionHeader = document.createElement("h2");
            accordionHeader.className = "accordion-header";
            const accordionButton = document.createElement("button");
            accordionButton.className = "accordion-button collapsed";
            accordionButton.type = "button";
            accordionButton.setAttribute("data-bs-toggle", "collapse");
            accordionButton.setAttribute("data-bs-target", `#collapse${accordionContainer.children.length}`);
            accordionButton.setAttribute("aria-expanded", "false");
            accordionButton.setAttribute("aria-controls", `collapse${accordionContainer.children.length}`);
            accordionButton.textContent = `提示詞流程 #${accordionContainer.children.length}`;
            accordionHeader.appendChild(accordionButton);
            const accordionCollapse = document.createElement("div");
            accordionCollapse.id = `collapse${accordionContainer.children.length}`;
            accordionCollapse.className = "accordion-collapse collapse";
            accordionCollapse.setAttribute("aria-labelledby", `heading${accordionContainer.children.length}`);
            accordionCollapse.setAttribute("data-bs-parent", "#accordionContainer");
            const accordionBody = document.createElement("div");
            accordionBody.className = "accordion-body p-4";
            const textarea = document.createElement("textarea");
            textarea.className = "form-control p-3";
            textarea.id = `formControlTextarea${accordionContainer.children.length}`;
            textarea.placeholder = `寫點提示詞吧！`;
            accordionBody.appendChild(textarea);
            accordionCollapse.appendChild(accordionBody);
            accordionItem.appendChild(accordionHeader);
            accordionItem.appendChild(accordionCollapse);
            accordionContainer.appendChild(accordionItem);
            textarea.style.height = "300px";
            textarea.addEventListener("input", function (e) {
                document.getElementById("save-link-section").innerHTML = "";
                this.style.height = "300px";
            });
        });
        document.getElementById("remove-btn").addEventListener("click", function () {
            document.getElementById("save-link-section").innerHTML = "";
            const accordionContainer = document.getElementById("accordionContainer");
            if (accordionContainer.children.length > 2) {
                accordionContainer.removeChild(accordionContainer.lastElementChild);
            }
        });
        document.getElementById("reset-btn").addEventListener("click", function () {
            document.getElementById("result").innerHTML = "";
        });
        document.getElementById("clear-btn").addEventListener("click", function () {
            // console.log("reset")
            let accordionContainer = document.getElementById("accordionContainer")
            let tmpAccordionItem1 = accordionContainer.querySelectorAll(".accordion-item")[0]
            let tmpAccordionItem2 = accordionContainer.querySelectorAll(".accordion-item")[1]
            tmpAccordionItem2.querySelector("textarea").value = "hi"
            accordionContainer.innerHTML = ""
            accordionContainer.appendChild(tmpAccordionItem1)
            accordionContainer.appendChild(tmpAccordionItem2)
            window.history.replaceState(null, '', './flow.html');
        });
        document.getElementById("close-btn").addEventListener("click", function () {
            // 獲取所有展開的 accordion-collapse 元素
            const expandedAccordions = document.querySelectorAll('#result .accordion-collapse.show');

            // 對每個展開的 accordion 進行收合
            expandedAccordions.forEach(accordion => {
                // 找到對應的按鈕
                const button = document.querySelector(`[data-bs-target="#${accordion.id}"]`);
                if (button && !button.classList.contains('collapsed')) {
                    button.click(); // 觸發按鈕的點擊事件來收合
                }
            });
        });
        document.getElementById("temperature-input").addEventListener("input", function () {
            document.getElementById("save-link-section").innerHTML = "";
            this.previousElementSibling.textContent = `發散程度：${this.value}`;
        });
        document.getElementById("execute-input").addEventListener("input", function () {
            document.getElementById("save-link-section").innerHTML = "";
            this.previousElementSibling.textContent = `執行次數：${this.value}`;
        });
        function getCurrentDateTimeWithMicroseconds() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = now.getMilliseconds();
            const microseconds = milliseconds * 1000;
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${String(microseconds).padStart(6, '0')}`;
        }

        async function sendRequests(execute, prompts, model, temperature, apikey, provide) {
            let reply;
            let result = document.getElementById("result");

            // 首先創建 modal（如果還不存在的話）
            if (!document.getElementById('expandModal')) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'expandModal';
                modal.tabIndex = '-1';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">完整內容</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="p-3 d-flex flex-column" id="modalContent"></div>
                                <textarea id="modalContentTextarea" class="d-none"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="copy-btn3" type="button" class="btn btn-dark">複製為 Markdown</button>
                                <button id="copy-btn4" type="button" class="btn btn-dark">複製</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById("copy-btn3").addEventListener('click', () => {
                let markdownContent = document.getElementById('modalContentTextarea').value
                navigator.clipboard.writeText(markdownContent).then(() => {
                    const shareCopyAlert = document.getElementById('shareCopyAlert');
                    shareCopyAlert.style.display = 'block';
                    setTimeout(() => {
                        shareCopyAlert.style.display = 'none';
                    }, 2000);
                }).catch(err => {
                    console.error('無法複製文字: ', err);
                });
            });

            document.getElementById("copy-btn4").addEventListener('click', () => {
                const e = document.getElementById("modalContent");
                const r = document.createRange();
                r.selectNodeContents(e);
                const s = window.getSelection();
                s.removeAllRanges();
                s.addRange(r);
                document.execCommand("copy");
                if (window.getSelection) {
                    window.getSelection().removeAllRanges(); // 現代瀏覽器
                } else if (document.selection) {
                    document.selection.empty(); // 舊版 IE
                }
                shareCopyAlert.style.display = 'block';
                setTimeout(() => {
                    shareCopyAlert.style.display = 'none';
                }, 2000);
            });

            // 創建一個通用的展開按鈕函數
            function createExpandButton(content) {
                let expandButton = document.createElement("button");
                expandButton.className = "btn btn-sm btn-dark";
                expandButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"/></svg>';

                expandButton.onclick = (e) => {
                    e.stopPropagation();
                    const modal = new bootstrap.Modal(document.getElementById('expandModal'));
                    let mdContent = md.render(content)
                    document.getElementById('modalContent').innerHTML = mdContent;
                    document.getElementById('modalContentTextarea').value = content;

                    modal.show();
                };

                return expandButton;
            }

            for (let i = 0; i < Number(execute); i++) {
                replyArr = []
                reply = "";

                const now = new Date();
                const timestamp = now.getTime();

                let accordion = document.createElement("div");
                accordion.className = "accordion mb-3";
                accordion.id = `accordion-${timestamp}`;

                // 創建 accordion item
                let accordionItem = document.createElement("div");
                accordionItem.className = "accordion-item";

                // 創建 accordion header
                let accordionHeader = document.createElement("h2");
                accordionHeader.className = "accordion-header";
                accordionHeader.id = `heading-${timestamp}`;

                // 創建 accordion button
                let accordionButton = document.createElement("button");
                accordionButton.className = "accordion-button";
                accordionButton.type = "button";
                accordionButton.setAttribute("data-bs-toggle", "collapse");
                accordionButton.setAttribute("data-bs-target", `#collapse-${timestamp}`);
                accordionButton.setAttribute("aria-expanded", "true");
                accordionButton.setAttribute("aria-controls", `collapse-${timestamp}`);

                // 創建時間戳記 span
                let timeSpan = document.createElement("span");
                timeSpan.textContent = getCurrentDateTimeWithMicroseconds();
                accordionButton.appendChild(timeSpan);

                // 創建 accordion collapse
                let accordionCollapse = document.createElement("div");
                accordionCollapse.id = `collapse-${timestamp}`;
                accordionCollapse.className = "accordion-collapse collapse show";
                accordionCollapse.setAttribute("aria-labelledby", `heading-${timestamp}`);

                // 創建 accordion body 和 chatCard
                let accordionBody = document.createElement("div");
                accordionBody.className = "accordion-body";
                let chatCard = document.createElement("div");
                chatCard.className = "chatCard";

                // 組裝 accordion 結構
                accordionHeader.appendChild(accordionButton);
                accordionBody.appendChild(chatCard);
                accordionCollapse.appendChild(accordionBody);
                accordionItem.appendChild(accordionHeader);
                accordionItem.appendChild(accordionCollapse);
                accordion.appendChild(accordionItem);

                result.insertBefore(accordion, result.firstChild);

                for (let j = 0; j < prompts.length; j++) {
                    // console.log(replyArr)
                    const prompt = prompts[j];
                    replyArr.push({ "role": "user", "content": prompt })
                    const body = {
                        "model": model,
                        "messages": [
                            ...replyArr
                        ],
                        "temperature": Number(temperature),
                        "max_tokens": 8192
                    };

                    const bodystr = JSON.stringify(body);
                    let cardContainer = document.createElement("div");
                    cardContainer.className = "d-flex w-100 mt-3";

                    // 創建提示詞容器
                    let promptContainer = document.createElement("div");
                    promptContainer.className = "card p-3 m-0 shadow-none bg-light rounded position-relative ask-sec me-2";

                    // 創建 content-wrapper
                    let promptWrapper = document.createElement("div");
                    promptWrapper.className = "content-wrapper";

                    // 創建提示詞文本元素
                    let promptText = document.createElement("pre");
                    promptText.textContent = prompt.trim();

                    // 添加展開按鈕到提示詞區域
                    let promptExpandButton = createExpandButton(prompt.trim());

                    // 組裝提示詞容器
                    promptWrapper.appendChild(promptText);
                    promptContainer.appendChild(promptWrapper);
                    cardContainer.appendChild(promptContainer);
                    cardContainer.appendChild(promptExpandButton);
                    chatCard.appendChild(cardContainer);

                    try {
                        let url, headers, response, data;
                        // console.log(provide)
                        if (provide.includes("openai")) {
                            url = "https://api.openai.com/v1/chat/completions"
                            headers = {
                                "content-type": "application/json",
                                "authorization": `Bearer ${apikey}`
                            }
                            response = await fetch(url, {
                                method: "POST",
                                headers: headers,
                                body: bodystr
                            });
                            data = await response.json();
                            reply = data.choices[0].message.content + "\n\n";
                            replyArr.push(data.choices[0].message)
                        }
                        if (provide.includes("deepseek")) {
                            url = "https://api.deepseek.com/chat/completions"
                            headers = {
                                "content-type": "application/json",
                                "authorization": `Bearer ${apikey}`
                            }
                            response = await fetch(url, {
                                method: "POST",
                                headers: headers,
                                body: bodystr
                            });
                            data = await response.json();
                            reply = data.choices[0].message.content + "\n\n";
                            replyArr.push(data.choices[0].message)
                        }
                        if (provide.includes("anthropic")) {
                            url = "https://api.anthropic.com/v1/messages"
                            headers = {
                                "content-type": "application/json",
                                "x-api-key": apikey,
                                "anthropic-version": "2023-06-01",
                                "anthropic-dangerous-direct-browser-access": "true",
                            }
                            response = await fetch(url, {
                                method: "POST",
                                headers: headers,
                                body: bodystr
                            });
                            data = await response.json();
                            reply = data.content[0].text + "\n\n";
                            replyArr.push({ "role": "assistant", "content": data.content[0].text })
                        }

                        let replyCardContainer = document.createElement("div");
                        replyCardContainer.className = "d-flex w-100 mt-3";

                        // 創建回覆容器
                        let replyContainer = document.createElement("div");
                        replyContainer.className = "card p-3 m-0 reply-sec position-relative me-2";

                        // 添加展開按鈕到回覆區域
                        let replyExpandButton = createExpandButton(reply);

                        // 創建內容區域
                        let contentDiv = document.createElement("div");
                        contentDiv.className = "content-wrapper";
                        let replyText = document.createElement("pre");
                        replyText.textContent = reply.trim();
                        contentDiv.appendChild(replyText);
                        if (contentDiv.lastElementChild) {
                            contentDiv.lastElementChild.className = "mb-0";
                        }

                        // 組裝回覆容器
                        replyContainer.appendChild(contentDiv);
                        replyCardContainer.appendChild(replyContainer);
                        replyCardContainer.appendChild(replyExpandButton);
                        chatCard.appendChild(replyCardContainer);

                    } catch (error) {
                        console.error("Error:", error);
                        // 創建錯誤提示
                        let errorDiv = document.createElement("div");
                        errorDiv.className = "alert alert-danger mt-3";
                        errorDiv.textContent = "發生錯誤：" + error.message;
                        chatCard.appendChild(errorDiv);
                    }
                }
            }
        }

        document.getElementById("send-btn").addEventListener("click", async function () {
            const sendBtn = this;
            // 獲取所有需要禁用的按鈕
            const saveBtn = document.getElementById("save-btn");
            const clearBtn = document.getElementById("clear-btn");
            const resetBtn = document.getElementById("reset-btn");
            const closeBtn = document.getElementById("close-btn");

            // 將所有按鈕禁用
            const buttons = [sendBtn, saveBtn, clearBtn, resetBtn, closeBtn];
            buttons.forEach(btn => btn.disabled = true);

            // 修改發送按鈕的顯示狀態
            sendBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                處理中...
            `;

            document.getElementById("save-link-section").innerHTML = "";

            const provide = document.getElementById("provide-select").value;
            let apikey;
            if (provide.includes("openai")) apikey = document.getElementById("openai-apikey-input").value;
            if (provide.includes("anthropic")) apikey = document.getElementById("anthropic-apikey-input").value;
            if (provide.includes("deepseek")) apikey = document.getElementById("deepseek-apikey-input").value;
            const model = provide.split(":")[1]
            const temperature = document.getElementById("temperature-input").value;
            const execute = document.getElementById("execute-input").value;
            const prompts = [];
            document.querySelectorAll("#accordionContainer textarea").forEach(function (textarea) {
                textarea.value = textarea.value.trim()
                if (textarea.value == "") return
                prompts.push(textarea.value);
            });
            try {
                await sendRequests(execute, prompts, model, temperature, apikey, provide);
            } catch (error) {
                console.error("Error:", error);
            } finally {
                // 恢復所有按鈕狀態
                buttons.forEach(btn => btn.disabled = false);
                sendBtn.innerHTML = "送出";

                // 先關閉所有展開的accordion
                // const expandedAccordions = document.querySelectorAll('#result .accordion-collapse.show');
                // expandedAccordions.forEach(accordion => {
                //     const button = document.querySelector(`[data-bs-target="#${accordion.id}"]`);
                //     if (button && !button.classList.contains('collapsed')) {
                //         button.click();
                //     }
                // });

                // sleep 500ms
                // await new Promise(resolve => setTimeout(resolve, 500));
                // console.log(document.querySelector('#result .accordion-button'))
                // document.querySelector('#result .accordion-button').click();
            }
        });


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>
</body>

</html>
