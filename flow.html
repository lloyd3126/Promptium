<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promptium｜輕鬆分享提示詞模板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&family=Noto+Sans+TC:wght@100..900&family=Racing+Sans+One&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="./static/favicon.ico">
    <style>
        * {
            font-family: "Noto Sans Mono", "Noto Sans TC", sans-serif;
        }

        body {
            height: 105vh;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            width: 100%;
            font-size: 1rem;
        }

        .accordion-button:focus {
            z-index: 3;
            border-color: rgba(0, 0, 0, .125);
            outline: 0;
            box-shadow: 0 0 0 .25rem rgba(0, 0, 0, .125);
        }

        .accordion-button:not(.collapsed) {
            color: #ffffff;
            background-color: rgba(0, 0, 0, .8);
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
        }

        .accordion-button:not(.collapsed)::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23212529'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }

        h1 {
            font-family: "Racing Sans One", sans-serif;
            font-weight: 400;
            font-style: normal;
            font-size: 64px;
            user-select: none;
            /* 標準屬性 */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
        }

        a:hover h1,
        .list-group {
            cursor: pointer;
        }

        a.text-decoration-none h1 {
            color: inherit;
            /* 繼承父元素的文字顏色 */
        }
    </style>
</head>

<body>
    <div class="container px-5 pt-5" style="max-width: 56rem; min-height: 102vh;">
        <div class="row mb-4">
            <div class="row mb-4">
                <a href="/" class="text-decoration-none link-dark">
                    <h1 class="text-center no-select">Promptium</h1>
                </a>
            </div>
        </div>
        <div class="row mb-4">
            <h2 class="fs-6 mb-3 fw-bold">如何使用</h2>
            <p>
                使用 Promptium 可以輕鬆的分享提示詞模板，只要輸入提示詞的名稱、說明和模板，並點擊產生分享連結，即可完成分享。更棒的是，啟用 Promptium
                的進階功能後，還能將使用案例一併分享出去。
            </p>
            <p class="m-0">
                <a class="btn btn-dark btn-sm" href="./index.html" role="button">
                    返回首頁
                </a>
            </p>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <h2 class="fs-6 mb-3 fw-bold">開始製作</h2>
            </div>
            <div class="col-12">
                <button id="add-btn" type="button" class="btn btn-dark btn-sm">增加流程</button>
                <button id="remove-btn" type="button" class="btn btn-dark btn-sm">減少流程</button>
                <button id="save-btn" type="button" class="btn btn-dark btn-sm">保存流程</button>
                <a class="btn btn-dark btn-sm" href="./flow.html" role="button" id="clear-btn">
                    清除流程
                </a>
                <a class="btn btn-dark btn-sm" role="button" href="./flow.html">
                    範例流程
                </a>
            </div>
            <div class="col-12">
                <div id="save-link-section"></div>
            </div>
        </div>
        <div class="accordion mb-3" id="accordionContainer">
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading0">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse0" aria-expanded="false" aria-controls="collapse0">
                        使用前別忘記要設定 ChatGPT
                    </button>
                </h2>
                <div id="collapse0" class="accordion-collapse collapse" aria-labelledby="heading0">
                    <div class="accordion-body p-4">
                        <div class="mb-3">
                            <label for="apikeyInput" class="form-label">OpenAI 的 API 金鑰</label>
                            <input class="form-control" id="apikey-input" placeholder="">
                        </div>
                        <div class="mb-3">
                            <label for="modelInput" class="form-label">使用模型</label>
                            <input class="form-control" id="model-input" placeholder="">
                        </div>
                        <div class="mb-3">
                            <label for="temperature-input" class="form-label">發散程度：0.3</label>
                            <input type="range" class="form-range" min="0" max="2" step="0.1" value="0.3"
                                id="temperature-input">
                        </div>
                        <div>
                            <label for="execute-input" class="form-label">執行次數：1</label>
                            <input type="range" class="form-range" min="1" max="20" step="1" value="1"
                                id="execute-input">
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading1">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                        提示詞流程 #1
                    </button>
                </h2>
                <div id="collapse1" class="accordion-collapse collapse" aria-labelledby="heading1">
                    <div class="accordion-body p-4">
                        <textarea class="form-control p-3" id="formControlTextarea1" placeholder="寫點提示詞吧！">hi</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <button type="button" class="btn btn-dark w-100" id="send-btn" disabled>送出</button>
        </div>
        <div class="mb-3" id="result"></div>
    </div>
    <footer class="mt-auto text-white-50 bg-dark text-center d-flex justify-content-center align-items-center"
        style="height: 50px;">
        <a class="mx-2 link-light" target="_blank" href="https://x.com/lloyd3126">
            Made by Chen Chung Nien
        </a>
        <a class="mx-2 link-light" target="_blank" href="https://prompter.fofr.ai/">
            Inspired by @fofrAI
        </a>
        <a class="mx-2 link-light" target="_blank" href="https://buymeacoffee.com/niencc">
            Buy me a coffee
        </a>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script>
        const md = window.markdownit();
        let mdResult = "";
        let replyArr = []

        function checkApiKey() {
            const apiKeyInput = document.getElementById("apikey-input");
            const sendBtn = document.getElementById("send-btn");
            sendBtn.disabled = !apiKeyInput.value.trim();
        }

        function decodeFromHash() {
            if (location.hash.startsWith('#data/')) {
                const base64 = location.hash.replace('#data/', '');
                try {
                    const decodedPrompt = fromBase64(base64);
                    const data = JSON.parse(decodedPrompt);
                    document.getElementById("model-input").value = data.model;
                    document.getElementById("temperature-input").value = data.temperature;
                    document.getElementById("execute-input").value = data.execute;
                    data.prompts.forEach(function (prompt, index) {
                        if (index === 0) {
                            // 為第一個提示詞更新現有的輸入欄位
                            const firstTextarea = document.getElementById("formControlTextarea1");
                            firstTextarea.value = prompt;
                            firstTextarea.style.height = "auto";
                            if (firstTextarea.scrollHeight < 176) {
                                firstTextarea.style.height = "176px";
                            } else {
                                firstTextarea.style.height = firstTextarea.scrollHeight + "px";
                            }
                        } else {
                            // 為其餘提示詞建立新的輸入欄位
                            const accordionContainer = document.getElementById("accordionContainer");
                            const accordionItem = document.createElement("div");
                            accordionItem.className = "accordion-item";

                            const accordionHeader = document.createElement("h2");
                            accordionHeader.className = "accordion-header";

                            const accordionButton = document.createElement("button");
                            accordionButton.className = "accordion-button collapsed";
                            accordionButton.type = "button";
                            accordionButton.setAttribute("data-bs-toggle", "collapse");
                            accordionButton.setAttribute("data-bs-target", `#collapse${index + 1}`);
                            accordionButton.setAttribute("aria-expanded", "false");
                            accordionButton.setAttribute("aria-controls", `collapse${index + 1}`);
                            accordionButton.textContent = `提示詞流程 #${index + 1}`;

                            accordionHeader.appendChild(accordionButton);

                            const accordionCollapse = document.createElement("div");
                            accordionCollapse.id = `collapse${index + 1}`;
                            accordionCollapse.className = "accordion-collapse collapse";
                            accordionCollapse.setAttribute("aria-labelledby", `heading${index + 1}`);

                            const accordionBody = document.createElement("div");
                            accordionBody.className = "accordion-body p-4";

                            const textarea = document.createElement("textarea");
                            textarea.className = "form-control p-3";
                            textarea.id = `formControlTextarea${index + 1}`;
                            textarea.placeholder = "寫點提示詞吧！";
                            textarea.value = prompt;

                            accordionBody.appendChild(textarea);
                            accordionCollapse.appendChild(accordionBody);
                            accordionItem.appendChild(accordionHeader);
                            accordionItem.appendChild(accordionCollapse);
                            accordionContainer.appendChild(accordionItem);

                            textarea.style.height = "176px";
                            textarea.style.overflowY = "hidden";
                            textarea.addEventListener("input", function (e) {
                                document.getElementById("save-link-section").innerHTML = "";
                                this.style.height = "auto";
                                if (this.scrollHeight < 176) {
                                    this.style.height = "176px";
                                } else {
                                    this.style.height = this.scrollHeight + "px";
                                }
                            });
                        }
                    });
                } catch (e) {
                    console.error("解碼時發生錯誤: ", e);
                }
            }
        }

        function handleHashChange() {
            decodeFromHash();
        }

        // 在頁面載入時讀取 localStorage 中的 API key
        document.addEventListener('DOMContentLoaded', function () {
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById("apikey-input").value = savedApiKey;
            }
            checkApiKey();
            handleHashChange();
            window.addEventListener('hashchange', handleHashChange);
        });

        /**
             * Base64 編碼：支持中文
             */
        function toBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        /**
         * Base64 解碼：與上面配套
         */
        function fromBase64(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        document.getElementById("save-btn").addEventListener("click", function () {
            const data = {
                model: document.getElementById("model-input").value,
                temperature: document.getElementById("temperature-input").value,
                execute: document.getElementById("execute-input").value,
                prompts: []
            };
            document.querySelectorAll("textarea").forEach(function (textarea) {
                data.prompts.push(textarea.value);
            });
            const jsonStr = JSON.stringify(data);
            const base64 = toBase64(jsonStr);
            const shareURL = `${window.location.origin}${window.location.pathname}#data/${base64}`;
            window.history.replaceState(null, '', shareURL);
            document.getElementById("save-link-section").innerHTML = `
                <div class="row mt-3">
                    <div class="col-9 col-md-10">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1">編輯連結</span>
                            <input type="text" class="form-control bg-white" id="shareLinkTextarea" readonly value="${shareURL}">
                        </div>
                    </div>
                    <div class="col-3 col-md-2">
                        <button id="copy-btn" type="button" class="w-100 btn btn-dark">複製</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-9 col-md-10">
                        <div class="input-group">
                            <span class="input-group-text" id="basic-addon1">分享連結</span>
                            <input type="text" class="form-control bg-white" id="shareLinkTextarea" readonly value="${shareURL}">
                        </div>
                    </div>
                    <div class="col-3 col-md-2">
                        <button id="copy-btn" type="button" class="w-100 btn btn-dark">複製</button>
                    </div>
                </div>
            `;
        });

        // 當 API key 輸入框值改變時，保存到 localStorage
        document.getElementById("apikey-input").addEventListener('change', function () {
            localStorage.setItem('openai_api_key', this.value);
            checkApiKey();
        });

        document.getElementById("model-input").value = "gpt-4o-mini";
        document.querySelectorAll("textarea").forEach(function (textarea) {
            textarea.style.height = "176px";
            textarea.style.overflowY = "hidden";
            textarea.addEventListener("input", function (e) {
                document.getElementById("save-link-section").innerHTML = "";
                this.style.height = "auto";
                if (this.scrollHeight < 176) {
                    this.style.height = "176px";
                } else {
                    this.style.height = this.scrollHeight + "px";
                }
            });
        });
        document.getElementById("add-btn").addEventListener("click", function () {
            document.getElementById("save-link-section").innerHTML = "";
            const accordionContainer = document.getElementById("accordionContainer");
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item";
            const accordionHeader = document.createElement("h2");
            accordionHeader.className = "accordion-header";
            const accordionButton = document.createElement("button");
            accordionButton.className = "accordion-button collapsed";
            accordionButton.type = "button";
            accordionButton.setAttribute("data-bs-toggle", "collapse");
            accordionButton.setAttribute("data-bs-target", `#collapse${accordionContainer.children.length}`);
            accordionButton.setAttribute("aria-expanded", "false");
            accordionButton.setAttribute("aria-controls", `collapse${accordionContainer.children.length}`);
            accordionButton.textContent = `提示詞流程 #${accordionContainer.children.length}`;
            accordionHeader.appendChild(accordionButton);
            const accordionCollapse = document.createElement("div");
            accordionCollapse.id = `collapse${accordionContainer.children.length}`;
            accordionCollapse.className = "accordion-collapse collapse";
            accordionCollapse.setAttribute("aria-labelledby", `heading${accordionContainer.children.length}`);
            accordionCollapse.setAttribute("data-bs-parent", "#accordionContainer");
            const accordionBody = document.createElement("div");
            accordionBody.className = "accordion-body p-4";
            const textarea = document.createElement("textarea");
            textarea.className = "form-control p-3";
            textarea.id = `formControlTextarea${accordionContainer.children.length}`;
            textarea.placeholder = `寫點提示詞吧！`;
            accordionBody.appendChild(textarea);
            accordionCollapse.appendChild(accordionBody);
            accordionItem.appendChild(accordionHeader);
            accordionItem.appendChild(accordionCollapse);
            accordionContainer.appendChild(accordionItem);
            textarea.style.height = "176px";
            textarea.style.overflowY = "hidden";
            textarea.addEventListener("input", function (e) {
                document.getElementById("save-link-section").innerHTML = "";
                this.style.height = "auto";
                if (this.scrollHeight < 176) {
                    this.style.height = "176px";
                } else {
                    this.style.height = this.scrollHeight + "px";
                }
            });
        });
        document.getElementById("remove-btn").addEventListener("click", function () {
            document.getElementById("save-link-section").innerHTML = "";
            const accordionContainer = document.getElementById("accordionContainer");
            if (accordionContainer.children.length > 2) {
                accordionContainer.removeChild(accordionContainer.lastElementChild);
            }
        });
        document.getElementById("temperature-input").addEventListener("input", function () {
            document.getElementById("save-link-section").innerHTML = "";
            this.previousElementSibling.textContent = `發散程度：${this.value}`;
        });
        document.getElementById("model-input").addEventListener("input", function () {
            document.getElementById("save-link-section").innerHTML = "";
        });
        document.getElementById("execute-input").addEventListener("input", function () {
            document.getElementById("save-link-section").innerHTML = "";
            this.previousElementSibling.textContent = `執行次數：${this.value}`;
        });
        function getCurrentDateTimeWithMicroseconds() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = now.getMilliseconds();
            const microseconds = milliseconds * 1000;
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${String(microseconds).padStart(6, '0')}`;
        }
        async function sendRequests(execute, prompts, model, temperature, apikey) {
            let reply;
            let result = document.getElementById("result");
            for (let i = 0; i < Number(execute); i++) {
                reply = "";
                let currentChat = document.createElement("div")
                currentChat.className = "mb-3 card p-4"
                result.insertBefore(currentChat, result.firstChild);
                let h6 = document.createElement("h6")
                h6.textContent = getCurrentDateTimeWithMicroseconds();
                h6.className = "m-0"
                currentChat.appendChild(h6)
                for (let j = 0; j < prompts.length; j++) {
                    const prompt = prompts[j];
                    const content = reply + prompt
                    const body = {
                        "model": model,
                        "messages": [
                            { "role": "user", "content": content }
                        ],
                        "temperature": Number(temperature)
                    };
                    const bodystr = JSON.stringify(body);
                    try {
                        const response = await fetch("https://api.openai.com/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${apikey}`
                            },
                            body: bodystr
                        });
                        const data = await response.json();
                        reply = data.choices[0].message.content + "\n\n";
                        replyArr.push(data)
                        let p = ""
                        let currentReply = ""
                        currentReply = document.createElement("pre")
                        currentReply.className = "card p-3 m-0 mt-3 shadow-none bg-light rounded"
                        currentReply.textContent = content.trim();
                        currentChat.appendChild(currentReply);
                        currentReply = document.createElement("div")
                        currentReply.className = "card p-3 m-0 mt-3"
                        currentChat.appendChild(currentReply);
                        mdResult = md.render(data.choices[0].message.content);
                        currentReply.innerHTML = mdResult;
                        currentReply.lastElementChild.className = "mb-0"
                    } catch (error) {
                        console.error("Error:", error);
                    }
                }
            }
        }
        document.getElementById("send-btn").addEventListener("click", async function () {
            document.getElementById("save-link-section").innerHTML = "";
            replyArr = []
            const apikey = document.getElementById("apikey-input").value;
            const model = document.getElementById("model-input").value;
            const temperature = document.getElementById("temperature-input").value;
            const execute = document.getElementById("execute-input").value;
            const prompts = [];
            document.querySelectorAll("textarea").forEach(function (textarea) {
                prompts.push(textarea.value);
            });
            const data = {
                apikey: apikey,
                model: model,
                temperature: temperature,
                execute: execute,
                prompts: prompts
            };
            await sendRequests(execute, prompts, model, temperature, apikey);
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>
</body>

</html>
